{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "environment": {
            "type": "string",
            "defaultValue": "d",
            "metadata": {
                "description":"Development environment"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location matches resource group"
            }
        },
        "dataProduct": {
            "type": "string",
            "metadata": {
                "description": "Use Case name"
            }
        },
        "resourceTags": {
            "type": "object",
            "defaultValue": {
                "environment": "[parameters('environment')]",
                "dataproduct": "[parameters('dataProduct')]",
                "costCenter": "finance",
                "serviceOwner": "Giang",
                "deployment": "ARM"
            }
        },
        "adlsConnectionstring": {
            "type": "securestring",
            "metadata": {
                "description": "Connectionstring of the Azure Data Lake Store"
            }
        },
           "akvUrl": {
            "type": "securestring",
            "metadata": {
                "description": "Connectionstring of the Azure Key Vault"
            }
        },
        "aSqlSecretName": {
            "type": "string",
            "metadata": {
                "description": "Secretname to the Azure SQL DB in the Azure Key Vault"
            }
        },
        "sharedIrResourceId": {
            "type": "securestring",
            "metadata": {
                "description": "Resource Id of the hub/shared Azure Data Factory"
            }
        },
        "linkedServiceFlag": {
            "type": "bool",
            "metadata": {
                "description": "Flag to activate or deactivate the resource for the Azure Data Factory - Linked Servicce"
            }
        },
        "linkedIRFlag": {
            "type": "bool",
            "metadata": {
                "description": "Flag to activate or deactivate the resource for the Azure Data Factory - Linked self hosted integration runtime"
            }
        },
        "abdWorkspaceUrl": {
            "type": "string",
            "metadata": {
                "description": "Azure Databricks Workspace Url"
            }
        },
        "adbSecretName": {
            "type": "string",
            "defaultValue": "adbAccessToken",
            "metadata": {
                "description": "Secret name of the Azure Databricks Access Token in the Azure Key Vault"
            }
        },
        "existingClusterId": {
            "type": "securestring",
            "defaultValue": "someId",
            "metadata": {
                "description": "Cluster Id"
            }
        }
    },
    "functions": [],
    "variables": {
        "dataFactoryName": "[toLower(concat('de-',parameters('dataProduct'),'-',parameters('environment'),'-df'))]"
    },
    "resources": [
        {
            "type": "Microsoft.DataFactory/factories",
            "apiVersion": "2018-06-01",
            "name": "[variables('dataFactoryName')]",
            "location": "[parameters('location')]",
            "tags": "[parameters('resourceTags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {},
            "resources": [
                {
                    "condition": "[parameters('linkedIRFlag')]",
                    "type": "integrationRuntimes",
                    "apiVersion": "2018-06-01",
                    "name": "sharedIr",
                    "properties": {
                        "type": "SelfHosted",
                        "description": "Linked Integration Runtime from the hub/shared Azure Data Factory",
                        "typeProperties": {
                            "linkedInfo":{
                                "resourceId": "[parameters('sharedIrResourceId')]",
                                "authorizationType": "Rbac"
                            }
                        }
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', variables('dataFactoryName'))]"
                    ]
                },
                {
                    "condition": "[parameters('linkedServiceFlag')]",
                    "type": "linkedservices",
                    "apiVersion": "2018-06-01",
                    "name": "arm_ls_adls",
                    "properties": {
                        "type": "AzureBlobFS",
                        "typeProperties": {
                            "url": "[parameters('adlsConnectionstring')]"
                        },
                        "description": "[concat('Linked Service to the Azure Data Lake Store in the resource group ',resourceGroup().name)]"
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', variables('dataFactoryName'))]"
                    ]
                },
                {
                    "condition": "[parameters('linkedServiceFlag')]",
                    "type": "linkedservices",
                    "apiVersion": "2018-06-01",
                    "name": "arm_ls_akv",
                    "properties": {
                        "type": "AzureKeyVault",
                        "typeProperties": {
                            "baseUrl": "[parameters('akvUrl')]" 
                        },
                        "description": "[concat('Linked Service to the Azure Key Vault in the resource group ',resourceGroup().name)]"
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', variables('dataFactoryName'))]"
                    ]
                },
                {
                    "condition": "[parameters('linkedServiceFlag')]",
                    "type": "linkedservices",
                    "apiVersion": "2018-06-01",
                    "name": "arm_ls_asql",
                    "properties": {
                        "type": "AzureSqlDatabase",
                        "typeProperties": {
                            "connectionString": {
                                "type": "AzureKeyVaultSecret",
                                "store":{
                                    "referenceName": "arm_ls_akv",
                                    "type": "LinkedServiceReference"
                                },
                                "secretName": "[parameters('aSqlSecretName')]"
                            }
                        },
                        "description": "[concat('Linked Service to the Azure SQL Database in the resource group ',resourceGroup().name)]"
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories/linkedservices', variables('dataFactoryName'), 'arm_ls_akv')]",
                        "[resourceId('Microsoft.DataFactory/factories', variables('dataFactoryName'))]"
                    ]
                },
                {
                    "condition": "[parameters('linkedServiceFlag')]",
                    "type": "linkedservices",
                    "apiVersion": "2018-06-01",
                    "name": "arm_ls_adb",
                    "properties": {
                        "type": "AzureDatabricks",
                        "typeProperties": {
                            "domain": "[parameters('abdWorkspaceUrl')]",
                            "accessToken": {
                                "type": "AzureKeyVaultSecret",
                                "store": {
                                    "referenceName": "arm_ls_akv",
                                    "type": "LinkedServiceReference"
                                },
                                "secretName": "[parameters('adbSecretName')]"
                            },
                            "existingClusterId": "[parameters('existingClusterId')]"
                        },
                        "description": "[concat('Linked Service to the Azure Databricks in the resource group ',resourceGroup().name)]"
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories/linkedservices', variables('dataFactoryName'), 'arm_ls_akv')]",
                        "[resourceId('Microsoft.DataFactory/factories', variables('dataFactoryName'))]"
                    ]
                }
            ]
        }
    ],
    "outputs": {
        "dataFactoryPrincipalId": {
            "type": "string",
            "value": "[reference(resourceId(resourceGroup().name,'Microsoft.DataFactory/factories',variables('dataFactoryName')),'2018-06-01','Full').identity.principalId]"
        },
        "dataFactoryName": {
            "type": "string",
            "value": "[variables('dataFactoryName')]"
        }
    }
}
